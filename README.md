# 直播弹幕和礼物监控脚本（暂只有b站）

这是一个用于监控直播间弹幕、礼物、舰长等信息的浏览器脚本，能够实时捕获直播间中的各种互动事件并进行结构化处理。暂时只完成了b站。

这是我的第一个勉强算功能完整的项目，可能结构上过于混乱了。目前还有很多问题需要慢慢解决，如果可以的话，可以通过chrome devTools添加代码段运行和调试下，确认没有什么数据处理的异常。

如果你只是内网使用可以搭配[简易server](https://github.com/sylw114/live-bridge-server)和[前端](https://github.com/sylw114/live-bridge-web)

## 功能特性

- **弹幕监控**：实时捕获用户发送的弹幕消息，包括文本和图片内容
- **礼物监控**：检测用户投喂的礼物信息，包括礼物名称、数量和用户信息
- **舰长监控**：识别舰长进入直播间的消息
- **连击礼物**：捕获连击礼物信息，包括连击次数
- **醒目留言**：监控付费醒目留言内容
- **粉丝牌信息**：提取用户粉丝牌等级和名称
- **错误日志**：记录解析失败的内容以便调试

## 数据类型

脚本会发送以下类型的数据：

- `danmu`：弹幕消息，包含用户名、消息内容和可选的粉丝牌信息
- `gift`：礼物信息，包含礼物名称、数量和用户名
- `captain`：舰长信息，包含用户名
- `giftCombo`：连击礼物，包含用户、礼物名和连击数
- `superChat`：超级留言，包含用户名、价格和留言内容

## 使用方法
0. 修改你所需的配置项（见ts文件开头）并编译：

- 首先你需要安装[nodejs](nodejs.org)
- 然后运行
```bash
npm i typescript -g
tsc
```
编译脚本默认会生成`dist/bili.js`文件，将其注入到B站直播间页面即可。你可以做成edge/chrome插件，也可以作为via脚本等。

- 部分主播的页面是嵌套页面，可能导致注入脚本不能正确获取对应元素。此时需要访问纯净的版本：
```
live.bilibili.com/blanc/<room_id>
```

1. 将此脚本注入到B站直播间页面
2. 脚本会在页面加载后设定时间自动启动监控
3. 所有捕获的消息会转换为JSON文本并发送

## 消息结构

见ts定义

## 功能支持情况

### 以下类型由于b站网页端的问题，导致依赖于网页的脚本无法实现

- 进场信息（部分用户会显示为图片，难以处理）

### 以下功能已确认良好支持

- 普通弹幕（单表情，带b站emoji的弹幕文本）
- superchat 结算时会添加到聊天区进而被捕获。可能会导致sc有一定延迟。sc确认只能这样实现，因为悬浮区不是一定会显示sc。

### 以下功能支持有限
- 悬浮区显示的礼物，包括礼盒。  
连击数据刷新时数据不会自动更新，总计数据依靠最终计算总和时更新到弹幕区的总数量数据。
- 底部进场信息显示的礼物信息  
礼物过多时底部显示区可能会跳过部分礼物的显示。未来可能会更新为使用悬浮礼物区的礼物数据。

### 以下功能暂未实现

- 直播间内用户头像
- 排行榜


### 暂不考虑实现的功能

- 用户点赞  
由于数据可能会较大，有可能严重拖慢脚本性能。因此暂不考虑
- 底部礼物 底部礼物会和悬浮区礼物重复
- 冠名礼物（礼物标识 由xxx冠名的礼物）  
增加为悬浮区礼物数据提取后，冠名礼物暂时无法被区分


# 你可以帮助我：

## 礼盒逻辑整理

现在不确定：
- 礼盒的爆出的数量是不是固定
- 是否可能出现不显示数量的情况  


## 悬浮区礼物显示情况

现在不确定：
- 悬浮区是否能显示所有礼物信息。目前有记录到底部区跳过部分礼物显示的情况，悬浮区我记得以前好像有没显示礼物的情况，但是我对我的记忆力不自信，亟需进一步确认。
